"use strict";define(["jquery","TYPO3/CMS/Sessionplaner/DragDrop","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Backend/Severity"],function(o,s,n,a){function e(){this.pageId=0,this.uiBlock=null,this.stash=null,this.gridButtonGroup=null,this.gridNewSessionButton=null,this.sessionData={},this.ajaxActive=!1,this.dragActive=!1,this.initialize()}return e.prototype.setPageId=function(e){this.pageId=e},e.prototype.getTemplateElement=function(e){return o(o("#"+e).html().replace(/^\s+|\s+$/g,""))},e.prototype.prepareData=function(e){var s={};return o.each(e,function(e,t){"attendees"!==t.name&&"type"!==t.name&&"level"!==t.name&&"day"!==t.name&&"room"!==t.name&&"slot"!==t.name||(t.value=parseInt(t.value)||0),s[t.name]=t.value}),s},e.prototype.applySessionValuesToForm=function(n,e){return o.each(e,function(e,t){var s=o("#session-form-"+e+":first",n);0<s.length&&s.val(t)}),n},e.prototype.applySessionValuesToCard=function(e,t){var s=e.find(".t3-page-ce-body-inner");return o.each(t,function(e,t){o("."+e,s).attr("data-value",t).text(t)}),e},e.prototype.addValuesFromParent=function(e,t){return"stash"===t.attr("id")?(e.slot=0,e.room=0):(e.slot=t.data("slot"),e.room=t.data("room")),e},e.prototype.createSessionCard=function(e){var t=this.getTemplateElement("sessionCardTemplate");return this.applySessionValuesToCard(t,e)},e.prototype.updateSessionCard=function(e){var t=o('.uid[data-value="'+e.uid+'"]',".t3js-page-ce").parents(".t3js-page-ce");this.applySessionValuesToCard(t,e)},e.prototype.getDataFromCard=function(e){var t=o(e).find(".t3-page-ce-body-inner"),s={};return t.find(".property").each(function(){var e=o(this);s[e.data("name")]=e.data("value")}),s},e.prototype.createSessionSuccess=function(e){this.sessionData.uid=e.data.uid;var t=this.createSessionCard(this.sessionData);this.sessionData.room&&this.sessionData.slot?o('[data-room="'+this.sessionData.room+'"][data-slot="'+this.sessionData.slot+'"]').prepend(t):this.stash.prepend(t),s.initializeDraggable(t)},e.prototype.updateSessionSuccess=function(){this.updateSessionCard(this.sessionData)},e.prototype.movedSessionSuccess=function(){},e.prototype.deleteSessionSuccess=function(){var t=this;o('[data-name="uid"]').each(function(){var e=o(this);parseInt(e.data("value"))===t.sessionData.uid&&e.parents(".t3-page-ce").remove()})},e.prototype.beforeSend=function(){var e=!0;return this.ajaxActive?e=!1:(this.ajaxActive=!0,this.uiBlock.removeClass("hidden")),e},e.prototype.afterSend=function(){this.uiBlock.addClass("hidden"),this.ajaxActive=!1},e.prototype.sendAjaxRequest=function(e,t,s){var n=this;o.ajax(TYPO3.settings.ajaxUrls[e],{method:"post",beforeSend:function(){n.beforeSend()},complete:function(){n.afterSend()},data:{id:n.pageId,tx_sessionplaner:{session:t}}}).done(s)},e.prototype.createSession=function(e){var t=this,s=this.prepareData(o("form",e.target).serializeArray());this.sessionData=s,this.sendAjaxRequest("evoweb_sessionplaner_create",this.sessionData,function(e){"error"!==e.status?t.createSessionSuccess(e):t.createNewSessionForm(s)})},e.prototype.updateSession=function(e){var t=this,s=this.prepareData(o("form",e.target).serializeArray());s.uid=this.sessionData.uid,this.sessionData=s,this.sendAjaxRequest("evoweb_sessionplaner_update",this.sessionData,function(e){"error"!==e.status?t.updateSessionSuccess(e):t.editSession(s)})},e.prototype.deleteSession=function(e){var t=this;this.sessionData={uid:o(e).parents(".t3-page-ce").find(".uid").data("value")},this.sendAjaxRequest("evoweb_sessionplaner_delete",this.sessionData,function(e){t.deleteSessionSuccess(e)})},e.prototype.movedSession=function(e,t){var s=this,n=this.getDataFromCard(e);this.sessionData=this.addValuesFromParent(n,t),this.sendAjaxRequest("evoweb_sessionplaner_update",this.sessionData,function(e){s.movedSessionSuccess(e)})},e.prototype.createNewSessionForm=function(e){var t=this;this.sessionData=e||{},n.confirm("Create session",this.applySessionValuesToForm(this.getTemplateElement("sessionFormTemplate"),this.sessionData),a.ok,[{text:"Create session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){n.dismiss()}).on("confirm.button.ok",function(e){t.createSession(e)})},e.prototype.createNewSessionFormInGrid=function(){var t=this;n.confirm("Create session",this.applySessionValuesToForm(this.getTemplateElement("sessionFormTemplate"),this.sessionData),a.ok,[{text:"Create session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){n.dismiss()}).on("confirm.button.ok",function(e){t.createSession(e)})},e.prototype.editSession=function(e){var t=this;this.sessionData=e,n.confirm("Edit session",this.applySessionValuesToForm(this.getTemplateElement("sessionFormTemplate"),this.sessionData),a.ok,[{text:"Update session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){n.dismiss()}).on("confirm.button.ok",function(e){t.updateSession(e)})},e.prototype.mouseOver=function(e){var t=o(e);this.sessionData={room:t.data("room"),slot:t.data("slot")},this.dragActive||0!==t.children().length||this.gridNewSessionButton.appendTo(t)},e.prototype.mouseOut=function(e,t){var s=t.toElement||t.relatedTarget;null!==s&&s!==e&&s.parentNode!==e&&s.parentNode.parentNode!==e&&s.parentNode.parentNode.parentNode!==e&&s.parentNode.parentNode.parentNode.parentNode!==e&&this.gridNewSessionButton.appendTo(this.gridButtonGroup)},e.prototype.initializeDragAndDrop=function(){var n=this,t=s.onDragStart,o=s.onDrop;s.onDragStart=function(e){n.dragActive=!0,t(e)},s.onDrop=function(e,t,s){n.movedSession(e,t),o(e,t,s),n.dragActive=!1}},e.prototype.initialize=function(){var t=this;this.uiBlock=o("#t3js-ui-block"),this.stash=o("#stash"),this.gridButtonGroup=o("#gridButtonGroup"),this.gridNewSessionButton=this.gridButtonGroup.find("#actions-document-new-in-grid"),o(document).on("click","#actions-document-new",function(){t.createNewSessionForm()}).on("click","#actions-document-new-in-grid",function(){t.createNewSessionFormInGrid()}).on("click",".icon-actions-edit-delete",function(){t.deleteSession(this)}).on("dblclick",".t3js-page-ce",function(){t.editSession(t.getDataFromCard(this))}).on("mouseover",".t3js-grid-cell",function(){t.mouseOver(this)}).on("mouseout",".t3js-grid-cell",function(e){t.mouseOut(this,e)}),this.initializeDragAndDrop()},new e});